<div style="max-width: 1000px; margin: 0 auto; padding: 20px;">
  <h1>ã‚¤ãƒ©ã‚¹ãƒˆç®¡ç†</h1>

  <%# --- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ --- %>
  <section style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 40px;">
    <h2>æ–°è¦ä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
    <form id="upload-form">
      <div style="margin-bottom: 15px;">
        <label style="display: block; font-weight: bold;">ãƒ•ã‚©ãƒ«ãƒ€å</label>
        <input type="text" id="illustrator-name" required style="width: 90%; padding: 8px;">
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; font-weight: bold;">ç”»åƒé¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</label>
        <input type="file" id="image-input" multiple accept="image/*" required>
      </div>

      <button type="submit" id="submit-btn" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
        ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹
      </button>
    </form>

    <%# ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çŠ¶æ³ï¼ˆä»¶æ•°ï¼‰ã‚’è¡¨ç¤º %>
    <div id="upload-status" style="margin-top: 15px; font-weight: bold; color: #007bff;"></div>
  </section>

  <hr style="margin: 40px 0;">

  <%# --- ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ --- %>
  <h2>ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§</h2>
  <div id="folder-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin-top: 20px;">
    <% @illustrators.each do |illustrator| %>
      <div class="folder-container" id="folder-<%= illustrator.name %>" style="position: relative;">
        
        <%# å‰Šé™¤ãƒœã‚¿ãƒ³ %>
        <button class="folder-delete-btn" 
                data-name="<%= illustrator.name %>" 
                style="position: absolute; top: 5px; right: 5px; background: #ff4d4d; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; z-index: 10; font-size: 14px; display: flex; align-items: center; justify-content: center;"
                title="ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤">
          Ã—
        </button>

        <%= link_to illustrator_folder_path(name: illustrator.name), class: "folder-item", style: "text-decoration: none; color: inherit; display: block;" do %>
          <div style="border: 1px solid #ddd; padding: 20px; border-radius: 10px; text-align: center; background: white; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <%# ã‚¢ãƒ«ãƒãƒ ã‚«ãƒãƒ¼ %>
            <div style="width: 100%; height: 120px; background: #f0f0f0; border-radius: 6px; margin-bottom: 10px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
              <%# ã‚«ãƒãƒ¼ç”»åƒã‚’è¡¨ç¤ºï¼ˆæŒ‡å®šãªã‘ã‚Œã°æœ€æ–°ç”»åƒï¼‰ %>
              <% display_illustration = illustrator.cover_illustration || illustrator.illustrations.last %>
              <% if display_illustration && display_illustration.image.attached? %>
                <%# ã‚µãƒ ãƒã‚¤ãƒ« %>
                <%= image_tag display_illustration.image.variant(resize_to_fill: [200, 200]), 
                              style: "width: 100%; height: 100%; object-fit: cover;" %>
              <% else %>
                <%# ç”»åƒãŒ1æšã‚‚ãªã„å ´åˆã¯ãƒ•ã‚©ãƒ«ãƒ€ã‚¢ã‚¤ã‚³ãƒ³ %>
                <div style="font-size: 40px;">ğŸ“</div>
              <% end %>
            </div>

            <div style="font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
              <%= illustrator.name %>
            </div>
            <div style="font-size: 12px; color: #888; margin-top: 5px;">
              <%= illustrator.illustrations.count %> æš
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<style>
  .folder-item:hover div {
    transform: translateY(-5px);
    border-color: #007bff !important;
    background-color: #f0f7ff !important;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const uploadForm = document.getElementById("upload-form");
  const submitBtn = document.getElementById("submit-btn");
  const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

  // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ä¸€æ‹¬ç®¡ç†ã™ã‚‹
  const setSubmitBtnState = (state) => {
    if (!submitBtn) return;

    switch (state) {
      case "loading": // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­
        submitBtn.disabled = true;
        submitBtn.innerText = "å‡¦ç†ä¸­...";
        submitBtn.style.backgroundColor = "#6c757d";
        submitBtn.style.cursor = "not-allowed";
        break;

      case "idle": // å¾…æ©ŸçŠ¶æ…‹
      default:
        submitBtn.disabled = false;
        submitBtn.innerText = "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹";
        submitBtn.style.backgroundColor = "#007bff";
        submitBtn.style.cursor = "pointer";
        break;
    }
  };

  // ===================================
  // ä¸¦åˆ—ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  // ===================================
  if (uploadForm) {
    uploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const nameInput = document.getElementById("illustrator-name");
      const imageInput = document.getElementById("image-input");
      const status = document.getElementById("upload-status");

      const name = nameInput.value;
      const files = Array.from(imageInput.files);

      // é€²æ—ç®¡ç†ç”¨
      const totalFiles = files.length;
      let completedCount = 0;
      let errorCount = 0;

      // ----------------------------------------
      // ä¸¦åˆ—ä¸Šé™
      // ----------------------------------------
      const CONCURRENCY_LIMIT = 3;

      // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’ã€Œã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã€ã®çŠ¶æ…‹ã«ã™ã‚‹
      setSubmitBtnState("loading");

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
      const updateStatus = () => {
        let message = `${totalFiles}æšä¸­ ${completedCount}æšã®é€ä¿¡ãŒå®Œäº†...`;
        
        if (errorCount > 0) {
          message += `ï¼ˆã†ã¡ ${errorCount}æš å¤±æ•—ï¼‰`;
        }
        
        status.innerText = message;
      };

      // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
      const uploadSingleFile = async (file) => {
        const formData = new FormData();
        formData.append("illustration[illustrator_name]", name);
        formData.append("illustration[image]", file);

        try {
          const response = await fetch("/illustrations", {
            method: "POST",
            headers: { "X-CSRF-Token": csrfToken },
            body: formData
          });

          if (!response.ok) throw new Error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—'); // -> catchã¸
          
          completedCount++;
          updateStatus();

        } catch (err) {
          console.error("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ", err);
          errorCount++;
          updateStatus();
        }
      };

      // ç”»åƒãŒãªããªã‚‹ã¾ã§å–ã‚Šå‡ºã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã¸
      const worker = async () => {
        while (files.length > 0) {
          const file = files.shift(); // è¡Œåˆ—ã®å…ˆé ­ã‹ã‚‰1æšå–ã‚Šå‡ºã™
          if (file) await uploadSingleFile(file);
        }
      };

      // æŒ‡å®šã—ãŸæ•°ã ã‘ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’åŒæ™‚ã«èµ·å‹•
      try {
        const workers = [];
        for (let i = 0; i < Math.min(CONCURRENCY_LIMIT, totalFiles); i++) {
          workers.push(worker());
        }
  
        // ã™ã¹ã¦ã®ãƒ¯ãƒ¼ã‚«ãƒ¼ã®å‡¦ç†ãŒçµ‚ã‚ã‚‹ã®ã‚’å¾…ã¤
        await Promise.all(workers);
  
        if (errorCount > 0) {
          status.innerText = `${completedCount}/${totalFiles} ä»¶ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿`
          status.style.color = "orange";
        } else {
          status.innerText = "æ­£å¸¸ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸï¼";
          status.style.color = "green";
        }
        
        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã«ãƒªãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œï¼ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’è‡ªå‹•çš„ã«è¡¨ç¤ºã™ã‚‹ãŸã‚ï¼‰
        setTimeout(() => {
          window.location.reload();
        }, 2000);

      } catch (err) {
        console.error("ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ", err);
        alert("ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        setSubmitBtnState("idle");
      }
    });
  }

  // ===================================
  // ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤
  // ===================================
  const deleteFolder = async (name) => {
    if (!window.confirm(`ãƒ•ã‚©ãƒ«ãƒ€ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nâ€»ä¸­ã®ç”»åƒã‚‚ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) return;

    try {
      const response = await fetch(`/folders/${encodeURIComponent(name)}`, {
        method: "DELETE",
        headers: { 
          "X-CSRF-Token": csrfToken,
          "Content-Type": "application/json"
        }
      });

      if (response.ok) {
        const element = document.getElementById(`folder-${name}`);
        if (element) {
          element.style.transition = "all 0.3s ease";
          element.style.opacity = "0";
          element.style.transform = "scale(0.8)";
          setTimeout(() => element.remove(), 300);
        }
      } else {
        alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    } catch (err) {
      alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
    }
  };

  // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".folder-delete-btn");
    if (btn) {
      e.stopPropagation(); // ãƒ•ã‚©ãƒ«ãƒ€è©³ç´°ã¸ã®é·ç§»ã‚’æ­¢ã‚ã‚‹
      e.preventDefault();
      deleteFolder(btn.dataset.name);
    }
  });

  
});
</script>