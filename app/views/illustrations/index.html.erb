<div style="max-width: 1000px; margin: 0 auto; padding: 20px;">
  <h1>ã‚¤ãƒ©ã‚¹ãƒˆç®¡ç†</h1>

  <%# --- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ --- %>
  <section style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 40px;">
    <h2>æ–°è¦ä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
    <form id="upload-form">
      <div style="margin-bottom: 15px;">
        <label style="display: block; font-weight: bold;">ãƒ•ã‚©ãƒ«ãƒ€å</label>
        <input type="text" id="illustrator-name" required style="width: 90%; padding: 8px;">
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; font-weight: bold;">ç”»åƒé¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</label>
        <input type="file" id="image-input" multiple accept="image/*" required>
      </div>

      <button type="submit" id="submit-btn" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
        ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹
      </button>
    </form>

    <%# ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çŠ¶æ³ï¼ˆä»¶æ•°ï¼‰ã‚’è¡¨ç¤º %>
    <div id="upload-status" style="margin-top: 15px; font-weight: bold; color: #007bff;"></div>
  </section>

  <hr style="margin: 40px 0;">

  <%# --- ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ --- %>
  <h2>ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§</h2>
  <div id="folder-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin-top: 20px;">
    <% @illustrators.each do |illustrator| %>
      <div class="folder-container" id="folder-<%= illustrator.name %>" style="position: relative;">
        
        <%# å‰Šé™¤ãƒœã‚¿ãƒ³ %>
        <button class="folder-delete-btn" 
                data-name="<%= illustrator.name %>" 
                style="position: absolute; top: 5px; right: 5px; background: #ff4d4d; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; z-index: 10; font-size: 14px; display: flex; align-items: center; justify-content: center;"
                title="ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤">
          Ã—
        </button>

        <%= link_to illustrator_folder_path(name: illustrator.name), class: "folder-item", style: "text-decoration: none; color: inherit; display: block;" do %>
          <div style="border: 1px solid #ddd; padding: 20px; border-radius: 10px; text-align: center; background: white; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <div style="font-size: 50px; margin-bottom: 10px;">ğŸ“</div>
            <div style="font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
              <%= illustrator.name %>
            </div>
            <div style="font-size: 12px; color: #888; margin-top: 5px;">
              <%= illustrator.illustrations.count %> æš
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<style>
  .folder-item:hover div {
    transform: translateY(-5px);
    border-color: #007bff !important;
    background-color: #f0f7ff !important;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const uploadForm = document.getElementById("upload-form");
  const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

  // ===================================
  // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  // ===================================
  if (uploadForm) {
    uploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const nameInput = document.getElementById("illustrator-name");
      const imageInput = document.getElementById("image-input");
      const status = document.getElementById("upload-status");
      const submitBtn = document.getElementById("submit-btn");

      const name = nameInput.value;
      const files = imageInput.files;    

      submitBtn.disabled = true;
      submitBtn.innerText = "å‡¦ç†ä¸­...";

      // é€æ¬¡ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      for (let i = 0; i < files.length; i++) {
        status.innerText = `${files.length}æšä¸­ ${i + 1}æšç›®ã‚’é€ä¿¡ä¸­...`;

        // ãƒ•ã‚©ãƒ¼ãƒ å€¤å–å¾—
        const formData = new FormData();
        formData.append("illustration[illustrator_name]", name);
        formData.append("illustration[image]", files[i]);

        try {
          const response = await fetch("/illustrations", {
            method: "POST",
            headers: { "X-CSRF-Token": csrfToken },
            body: formData
          });

          const result = await response.json();

          if (!response.ok) {
            status.innerText = `ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ${result.error || 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—'}`;
            status.style.color = "red";
            submitBtn.disabled = false;
            return;
          }
        } catch (err) {
          status.innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
          status.style.color = "red";
          submitBtn.disabled = false;
          return;
        }
      }

      status.innerText = "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼";
      status.style.color = "green";
      
      // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã«ãƒªãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œï¼ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’è‡ªå‹•çš„ã«è¡¨ç¤ºã™ã‚‹ãŸã‚ï¼‰
      setTimeout(() => {
        window.location.reload();
      }, 1500);
    });
  }

  // ===================================
  // ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤
  // ===================================
  const deleteFolder = async (name) => {
    if (!window.confirm(`ãƒ•ã‚©ãƒ«ãƒ€ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nâ€»ä¸­ã®ç”»åƒã‚‚ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) return;

    try {
      const response = await fetch(`/folders/${encodeURIComponent(name)}`, {
        method: "DELETE",
        headers: { 
          "X-CSRF-Token": csrfToken,
          "Content-Type": "application/json"
        }
      });

      if (response.ok) {
        const element = document.getElementById(`folder-${name}`);
        if (element) {
          element.style.transition = "all 0.3s ease";
          element.style.opacity = "0";
          element.style.transform = "scale(0.8)";
          setTimeout(() => element.remove(), 300);
        }
      } else {
        alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    } catch (err) {
      alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
    }
  };

  // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".folder-delete-btn");
    if (btn) {
      e.stopPropagation(); // ãƒ•ã‚©ãƒ«ãƒ€è©³ç´°ã¸ã®é·ç§»ã‚’æ­¢ã‚ã‚‹
      e.preventDefault();
      deleteFolder(btn.dataset.name);
    }
  });

  
});
</script>