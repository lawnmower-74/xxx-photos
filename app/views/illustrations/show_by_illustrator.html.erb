<div style="max-width: 1000px; margin: 0 auto; padding: 20px;">
  <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
    <%= link_to "← フォルダ一覧に戻る", root_path, style: "color: #666; text-decoration: none;" %>
    
    <%# --- 一括削除ボタン（最初は非表示） --- %>
    <button id="bulk-delete-btn" style="display: none; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
      選択した項目を削除
    </button>
  </div>

  <h1><%= @illustrator.name %> の作品一覧</h1>

  <div id="illustration-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">
    <% @illustrations.each do |illustration| %>
      <div class="illustration-item" id="item-<%= illustration.id %>" style="position: relative; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: white;">
        
        <%# --- 選択用チェックボックス --- %>
        <input type="checkbox" class="delete-checkbox" data-id="<%= illustration.id %>" 
               style="position: absolute; top: 10px; left: 10px; z-index: 10; width: 20px; height: 20px; cursor: pointer;">

        <% if illustration.image.attached? %>
          <%= link_to url_for(illustration.image), target: "_blank" do %>
            <%= image_tag illustration.image, style: "width: 100%; height: 200px; object-fit: cover; display: block;" %>
          <% end %>
        <% end %>

        <div style="padding: 10px; display: flex; justify-content: space-between; align-items: center;">
          <span style="font-size: 0.8em; color: #666;">
            <%= illustration.shot_at&.strftime("%m/%d %H:%M") %>
          </span>
          <%# --- 個別削除ボタン --- %>
          <button class="single-delete-btn" data-id="<%= illustration.id %>" 
                  style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 0.9em;">
            削除
          </button>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const bulkDeleteBtn = document.getElementById("bulk-delete-btn");
  const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

  // --- 1. 一括削除ボタンの表示・非表示を切り替える関数 ---
  const updateBulkButtonVisibility = () => {
    const checkedCount = document.querySelectorAll(".delete-checkbox:checked").length;
    if (bulkDeleteBtn) {
      bulkDeleteBtn.style.display = checkedCount > 0 ? "block" : "none";
      bulkDeleteBtn.innerText = `選択した ${checkedCount} 件を削除`;
    }
  };

  // --- 2. 削除処理の共通関数 ---
  const deleteIllustrations = async (ids) => {
    const message = ids.length > 1 
      ? `選択した ${ids.length} 件の画像を完全に削除してもよろしいですか？` 
      : "この画像を削除してもよろしいですか？";

    if (!window.confirm(message)) return;

    try {
      const response = await fetch("/illustrations/bulk_destroy", {
        method: "DELETE",
        headers: { 
          "X-CSRF-Token": csrfToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ ids: ids })
      });

      if (response.ok) {
        // 成功時の処理
        ids.forEach(id => {
          const element = document.getElementById(`item-${id}`);
          if (element) {
            element.style.opacity = "0";
            setTimeout(() => element.remove(), 300);
          }
        });
        // ここでエラーが起きていた可能性が高いので、関数の存在を確認して実行
        setTimeout(updateBulkButtonVisibility, 350);
      } else {
        const errorData = await response.json().catch(() => ({}));
        alert("削除に失敗しました: " + (errorData.error || "サーバーエラー"));
      }
    } catch (err) {
      // 削除自体は成功していても、JSの実行エラーがここで「通信エラー」として表示される
      console.error("JS Error Detail:", err);
      alert("通信エラー、またはプログラムエラーが発生しました。");
    }
  };

  // --- 3. イベントリスナーの設定 ---

  // チェックボックスの変更を監視
  document.addEventListener("change", (e) => {
    if (e.target.classList.contains("delete-checkbox")) {
      updateBulkButtonVisibility();
    }
  });

  // 個別削除ボタン
  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".single-delete-btn");
    if (btn) {
      deleteIllustrations([btn.dataset.id]);
    }
  });

  // 一括削除ボタン
  if (bulkDeleteBtn) {
    bulkDeleteBtn.addEventListener("click", () => {
      const selectedIds = Array.from(document.querySelectorAll(".delete-checkbox:checked"))
                               .map(cb => cb.dataset.id);
      deleteIllustrations(selectedIds);
    });
  }
});
</script>