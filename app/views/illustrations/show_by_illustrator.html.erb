<%# --- ã‚®ãƒ£ãƒ©ãƒªãƒ¼åŒ–ãƒ©ã‚¤ãƒ–ãƒ©ãƒª --- %>
<script src="https://cdn.jsdelivr.net/npm/spotlight.js@0.7.8/dist/spotlight.bundle.js"></script>

<div style="max-width: 1000px; margin: 0 auto; padding: 20px;">
  <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
    <%= link_to "< ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ã«æˆ»ã‚‹", root_path, style: "color: #666; text-decoration: none;" %>
    
    <%# --- ä¸€æ‹¬å‰Šé™¤ãƒœã‚¿ãƒ³ --- %>
    <button id="bulk-delete-btn" style="display: none; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
      é¸æŠã—ãŸé …ç›®ã‚’å‰Šé™¤
    </button>
  </div>

  <h1><%= @illustrator.name %> ã®ä½œå“ä¸€è¦§</h1>

  <%# --- ä¸¦ã¹æ›¿ãˆãƒœã‚¿ãƒ³ --- %>
  <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
    <span style="font-weight: bold; font-size: 0.9em;">ä¸¦ã¹æ›¿ãˆï¼š</span>

    <%= link_to "æœ€æ–°é †", illustrator_folder_path(name: @illustrator.name, sort: 'desc'), 
        class: "sort-link #{'active' if params[:sort] != 'asc'}" %>

    <span style="color: #ccc;">|</span>

    <%= link_to "å¤ã„é †", illustrator_folder_path(name: @illustrator.name, sort: 'asc'), 
        class: "sort-link #{'active' if params[:sort] == 'asc'}" %>
  </div>

  <%# --- ç”»åƒä¸€è¦§ --- %>
  <div id="illustration-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">
    <% @illustrations.each do |illustration| %>
      <div class="illustration-item" id="item-<%= illustration.id %>" style="position: relative; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: white; transition: all 0.3s ease;">
        
        <%# ä¸€æ‹¬å‰Šé™¤ç”¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ %>
        <input type="checkbox" class="delete-checkbox" data-id="<%= illustration.id %>" 
               style="position: absolute; top: 10px; left: 10px; z-index: 10; width: 20px; height: 20px; cursor: pointer;">

        <%# ç”»åƒè¡¨ç¤º %>
        <% if illustration.image.attached? %>
          <%# æ‹¡å¤§ãƒªãƒ³ã‚¯ï¼ˆã‚¯ãƒªãƒƒã‚¯æ™‚ã«åŸå¯¸å¤§ã®ç”»åƒã‚’è¡¨ç¤ºï¼‰ %>
          <a href="<%= url_for(illustration.image) %>"
             class="spotlight" 
             data-group="gallery"
             style="display: block;">
            <%# ã‚µãƒ ãƒã‚¤ãƒ« %>
            <%= image_tag illustration.image.variant(resize_to_limit: [300, 300]), 
                          loading: "lazy",
                          style: "width: 100%; height: 200px; object-fit: cover; display: block;" %>
          </a>
        <% end %>

        <div style="padding: 10px; display: flex; justify-content: space-between; align-items: center;">
          <%# æ’®å½±æ—¥æ™‚ %>
          <span style="font-size: 0.8em; color: #666;">
            ğŸ“… <%= illustration.shot_at&.strftime("%m/%d %H:%M") %>
          </span>

          <div style="display: flex; gap: 10px;">
            <%# ã‚¢ãƒ«ãƒãƒ ã‚«ãƒãƒ¼è¨­å®šãƒœã‚¿ãƒ³ %>
            <button class="set-cover-btn" data-id="<%= illustration.id %>" 
                    style="background: none; border: none; color: #007bff; cursor: pointer; font-size: 0.9em;"
                    title="ã“ã®ç”»åƒã‚’ãƒ•ã‚©ãƒ«ãƒ€ã®è¡¨ç´™ã«ã™ã‚‹">
              â˜… è¡¨ç´™
            </button>

            <%# å€‹åˆ¥å‰Šé™¤ãƒœã‚¿ãƒ³ %>
            <button class="single-delete-btn" data-id="<%= illustration.id %>" 
                    style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 0.9em;">
              å‰Šé™¤
            </button>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<style>
  .illustration-item.selecting {
    border-color: #007bff !important;
    box-shadow: 0 0 10px rgba(0,123,255,0.2);
  }
  /* ç”»åƒã®æ‹¡å¤§ãƒªãƒ³ã‚¯ï¼ˆSpotlightï¼‰ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã‚¯ãƒ©ã‚¹ */
  .disable-gallery {
    pointer-events: none;
    cursor: default;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const bulkDeleteBtn = document.getElementById("bulk-delete-btn");
  const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

  // ===================================
  // ç”»åƒå‰Šé™¤å‡¦ç†
  // ===================================
  // -----------------------------------
  // é¸æŠãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆï¼ˆä¸€æ‹¬å‰Šé™¤ï¼‰
  // -----------------------------------
  const toggleSelectingMode = () => {
    const checkboxes = document.querySelectorAll(".delete-checkbox");
    const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
    const isSelecting = checkedCount > 0;

    // æ‹¡å¤§ãƒªãƒ³ã‚¯ã®æœ‰åŠ¹ï¼ç„¡åŠ¹ åˆ‡ã‚Šæ›¿ãˆï¼ˆ1æšã§ã‚‚é¸æŠã•ã‚ŒãŸå ´åˆã¯æ‹¡å¤§ã‚’ç„¡åŠ¹åŒ–ï¼‰
    document.querySelectorAll(".illustration-item").forEach(item => {
      const link = item.querySelector(".spotlight");
      item.classList.toggle("selecting", isSelecting);
      link.classList.toggle("disable-gallery", isSelecting);
    });

    // ä¸€æ‹¬å‰Šé™¤ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºï¼éè¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ
    if (bulkDeleteBtn) {
      bulkDeleteBtn.style.display = isSelecting ? "block" : "none";
      setBulkDeleteBtnState("idle", checkedCount)
    }
  };

  // ã€Œä¸€æ‹¬å‰Šé™¤ãƒœã‚¿ãƒ³ã€è¡¨ç¤ºæ™‚ ã®UIã‚’ç®¡ç†
  const setBulkDeleteBtnState = (state, checkedCount = 0) => {
    if (!bulkDeleteBtn) return;

    switch (state) {
      case "idle": // é€šå¸¸ï¼ˆå¾…æ©Ÿï¼‰çŠ¶æ…‹
        bulkDeleteBtn.disabled = false;
        bulkDeleteBtn.innerText = `é¸æŠã—ãŸ ${checkedCount} ä»¶ã‚’å‰Šé™¤`;
        bulkDeleteBtn.style.backgroundColor = "#dc3545";
        bulkDeleteBtn.style.cursor = "pointer";
        break;

      case "loading": // å‰Šé™¤å®Ÿè¡Œä¸­
        bulkDeleteBtn.disabled = true;
        bulkDeleteBtn.innerText = "å‰Šé™¤å‡¦ç†ä¸­...";
        bulkDeleteBtn.style.backgroundColor = "#6c757d";
        bulkDeleteBtn.style.cursor = "not-allowed";
        break;
    }
  }

  // -----------------------------------
  // å‰Šé™¤å‡¦ç†ï¼ˆå€‹åˆ¥ï¼ä¸€æ‹¬å…±é€šï¼‰
  // -----------------------------------
  const deleteIllustrations = async (ids) => {
    // ç¢ºèªç”¨ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
    const message = ids.length > 1 
      ? `é¸æŠã—ãŸ ${ids.length} ä»¶ã®ç”»åƒã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ` 
      : "ã“ã®ç”»åƒã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ";

    if (!window.confirm(message)) return;

    // ã€Œä¸€æ‹¬å‰Šé™¤ãƒœã‚¿ãƒ³ã€ã®çŠ¶æ…‹ã‚’ã€Œå‰Šé™¤ä¸­ã€ã«åˆ‡ã‚Šæ›¿ãˆ
    setBulkDeleteBtnState("loading")

    try {
      const response = await fetch("/illustrations/bulk_destroy", {
        method: "DELETE",
        headers: { 
          "X-CSRF-Token": csrfToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ ids: ids })
      });

      if (response.ok) {
        // ç”»åƒã‚’ç”»é¢ä¸Šã‹ã‚‰ã‚‚æ¶ˆã™
        ids.forEach(id => {
          const element = document.getElementById(`item-${id}`);
          if (element) {
            element.style.transition = "all 0.3s ease";
            element.style.opacity = "0";
            element.style.transform = "scale(0.8)";
            setTimeout(() => {
              element.remove();
              toggleSelectingMode(); // é¸æŠãƒ¢ãƒ¼ãƒ‰OFF
            }, 300);
          }
        });
      } else {
        const errorData = await response.json().catch(() => ({}));
        alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (errorData.error || "ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼"));
        toggleSelectingMode(); // é¸æŠãƒ¢ãƒ¼ãƒ‰ONï¼ˆâ€»ãƒã‚§ãƒƒã‚¯ã—ãŸã‚‚ã®ãŒæ®‹ã£ã¦ã„ãŸå ´åˆï¼‰
      }
    } catch (err) {
      console.error("JSé–¢é€£ã®ã‚¨ãƒ©ãƒ¼: ", err);
      alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
      toggleSelectingMode(); // é¸æŠãƒ¢ãƒ¼ãƒ‰ONï¼ˆâ€»ãƒã‚§ãƒƒã‚¯ã—ãŸã‚‚ã®ãŒæ®‹ã£ã¦ã„ãŸå ´åˆï¼‰
    }
  };

  // ===================================
  // ã‚¢ãƒ«ãƒãƒ ã‚«ãƒãƒ¼è¨­å®šå‡¦ç†
  // ===================================
  const setFolderCover = async (imageId) => {
    const folderName = "<%= @illustrator.name %>";

    try {
      const response = await fetch(`/folders/${encodeURIComponent(folderName)}/set_cover`, {
        method: "PATCH",
        headers: { 
          "X-CSRF-Token": csrfToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ image_id: imageId })
      });

      if (response.ok) {
        alert("ã‚¢ãƒ«ãƒãƒ ã®è¡¨ç´™ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼");
        window.location.reload(); 
      } else {
        alert("è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    } catch (err) {
      console.error("ã‚«ãƒãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼: ", err);
      alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
    }
  };

  // ===================================
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
  // ===================================
  // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
  document.addEventListener("click", (e) => {
    const deleteBtn = e.target.closest(".single-delete-btn");
    const coverBtn = e.target.closest(".set-cover-btn");
    const bulkBtn = e.target.closest("#bulk-delete-btn");

    // å‰Šé™¤ãƒœã‚¿ãƒ³
    if (deleteBtn) {
      e.preventDefault(); // â€»ãƒªãƒ³ã‚¯ï¼ˆæ‹¡å¤§è¡¨ç¤ºï¼‰ã®ç™ºç«ã‚’é˜²ã
      deleteIllustrations([deleteBtn.dataset.id]);
      return;
    }

    // ã‚¢ãƒ«ãƒãƒ ã‚«ãƒãƒ¼è¨­å®šãƒœã‚¿ãƒ³
    if (coverBtn) {
      e.preventDefault();
      setFolderCover(coverBtn.dataset.id);
      return;
    }

    // ä¸€æ‹¬å‰Šé™¤ãƒœã‚¿ãƒ³
    if (bulkBtn) {
      const selectedIds = Array.from(document.querySelectorAll(".delete-checkbox:checked")).map(cb => cb.dataset.id);
      deleteIllustrations(selectedIds);
      return;
    }

    // é¸æŠãƒ¢ãƒ¼ãƒ‰ONã§ã‚ã‚Œã°ã€ç”»åƒã®ã©ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚ãƒã‚§ãƒƒã‚¯åè»¢ã—ã‹ã§ããªã„ã‚ˆã†ã«ã™ã‚‹
    const item = e.target.closest(".illustration-item");
    if (item) {
      const checkbox = item.querySelector(".delete-checkbox");

      // ç”»é¢å…¨ä½“ã§ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸã‚‚ã®ãŒã‚ã‚‹ã‹ï¼ˆé¸æŠãƒ¢ãƒ¼ãƒ‰ONã‹ï¼‰ã‚’ç¢ºèª
      const isSelecting = document.querySelectorAll(".delete-checkbox:checked").length > 0;
      if (isSelecting) {
        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ä»¥å¤–ã®å ´æ‰€ï¼ˆâ€»ç”»åƒã‚«ãƒ¼ãƒ‰æ å†…ï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸãªã‚‰ã€ãƒã‚§ãƒƒã‚¯ã‚’åè»¢ã•ã›ã‚‹
        if (e.target !== checkbox) {
          e.preventDefault();
          checkbox.checked = !checkbox.checked;
          toggleSelectingMode(); // é¸æŠãƒ¢ãƒ¼ãƒ‰ONï¼OFF
        }
      }
    }
  });

  // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼ˆãƒã‚§ãƒƒã‚¯å…¥ã‚ŒãŸæ™‚ï¼å¤–ã—ãŸæ™‚ï¼‰
  document.addEventListener("change", (e) => {
    if (e.target.classList.contains("delete-checkbox")) {
      toggleSelectingMode(); // é¸æŠãƒ¢ãƒ¼ãƒ‰ONï¼OFF
    }
  });
});
</script>