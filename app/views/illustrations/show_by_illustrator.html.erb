<%# ã‚®ãƒ£ãƒ©ãƒªãƒ¼åŒ–ãƒ©ã‚¤ãƒ–ãƒ©ãƒª %>
<script src="https://cdn.jsdelivr.net/npm/spotlight.js@0.7.8/dist/spotlight.bundle.js"></script>

<div style="max-width: 1000px; margin: 0 auto; padding: 20px;">
  <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
    <%= link_to "< ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ã«æˆ»ã‚‹", root_path, style: "color: #666; text-decoration: none;" %>
    
    <%# --- ä¸€æ‹¬å‰Šé™¤ãƒœã‚¿ãƒ³ --- %>
    <button id="bulk-delete-btn" style="display: none; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
      é¸æŠã—ãŸé …ç›®ã‚’å‰Šé™¤
    </button>
  </div>

  <h1><%= @illustrator.name %> ã®ä½œå“ä¸€è¦§</h1>

  <%# --- ä¸¦ã¹æ›¿ãˆãƒœã‚¿ãƒ³ --- %>
  <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
    <span style="font-weight: bold; font-size: 0.9em;">ä¸¦ã¹æ›¿ãˆï¼š</span>

    <%= link_to "æœ€æ–°é †", illustrator_folder_path(name: @illustrator.name, sort: 'desc'), 
        class: "sort-link #{'active' if params[:sort] != 'asc'}" %>

    <span style="color: #ccc;">|</span>

    <%= link_to "å¤ã„é †", illustrator_folder_path(name: @illustrator.name, sort: 'asc'), 
        class: "sort-link #{'active' if params[:sort] == 'asc'}" %>
  </div>

  <%# --- ç”»åƒä¸€è¦§ --- %>
  <div id="illustration-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">
    <% @illustrations.each do |illustration| %>
      <div class="illustration-item" id="item-<%= illustration.id %>" style="position: relative; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: white; transition: all 0.3s ease;">
        
        <%# --- é¸æŠç”¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ --- %>
        <input type="checkbox" class="delete-checkbox" data-id="<%= illustration.id %>" 
               style="position: absolute; top: 10px; left: 10px; z-index: 10; width: 20px; height: 20px; cursor: pointer;">

        <% if illustration.image.attached? %>
          <a href="<%= url_for(illustration.image) %>" <%# â€»æ‹¡å¤§è¡¨ç¤ºã¯åŸå¯¸å¤§ã®ç”»åƒã‚’è¡¨ç¤º %>
             class="spotlight" 
             data-group="gallery"
             data-title="<%= illustration.shot_at&.strftime('%Y-%m-%d %H:%M') %>"
             style="display: block;">
            <% if illustration.image.attached? %>
              <%# ã‚µãƒ ãƒè¡¨ç¤º %>
              <%= image_tag illustration.image.variant(resize_to_limit: [300, 300]), 
                            loading: "lazy",
                            style: "width: 100%; height: 200px; object-fit: cover; display: block;" %>
            <% end %>
          </a>
        <% end %>

        <div style="padding: 10px; display: flex; justify-content: space-between; align-items: center;">
          <%# --- æ’®å½±æ—¥æ™‚ --- %>
          <span style="font-size: 0.8em; color: #666;">
            ğŸ“… <%= illustration.shot_at&.strftime("%m/%d %H:%M") %>
          </span>

          <%# --- å€‹åˆ¥å‰Šé™¤ãƒœã‚¿ãƒ³ --- %>
          <button class="single-delete-btn" data-id="<%= illustration.id %>" 
                  style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 0.9em;">
            å‰Šé™¤
          </button>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const bulkDeleteBtn = document.getElementById("bulk-delete-btn");
  const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

  // ä¸€æ‹¬å‰Šé™¤ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
  const updateBulkButtonVisibility = () => {
    const checkedCount = document.querySelectorAll(".delete-checkbox:checked").length;
    if (bulkDeleteBtn) {
      bulkDeleteBtn.style.display = checkedCount > 0 ? "block" : "none";
      bulkDeleteBtn.innerText = `é¸æŠã—ãŸ ${checkedCount} ä»¶ã‚’å‰Šé™¤`;
    }
  };

  // å‰Šé™¤å‡¦ç†ï¼ˆå€‹åˆ¥ï¼é¸æŠå…±é€šï¼‰
  const deleteIllustrations = async (ids) => {
    // ç¢ºèªç”¨ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
    const message = ids.length > 1 
      ? `é¸æŠã—ãŸ ${ids.length} ä»¶ã®ç”»åƒã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ` 
      : "ã“ã®ç”»åƒã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ";

    if (!window.confirm(message)) return;

    // å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    try {
      const response = await fetch("/illustrations/bulk_destroy", {
        method: "DELETE",
        headers: { 
          "X-CSRF-Token": csrfToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ ids: ids })
      });

      if (response.ok) {
        // ç”»åƒã‚’ç”»é¢ä¸Šã‹ã‚‰ã‚‚æ¶ˆã™
        ids.forEach(id => {
          const element = document.getElementById(`item-${id}`);
          if (element) {
            element.style.transition = "all 0.3s ease";
            element.style.opacity = "0";
            element.style.transform = "scale(0.8)";
            setTimeout(() => element.remove(), 300);
          }
        });
        // ä¸€æ‹¬å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«
        setTimeout(updateBulkButtonVisibility, 350);
      } else {
        const errorData = await response.json().catch(() => ({}));
        alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (errorData.error || "ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼"));
      }
    } catch (err) {
      console.error("JS Error Detail:", err);
      alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
    }
  };

  // ===================================
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
  // ===================================

  // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
  document.addEventListener("change", (e) => {
    if (e.target.classList.contains("delete-checkbox")) {
      updateBulkButtonVisibility();
    }
  });

  // å€‹åˆ¥å‰Šé™¤ãƒœã‚¿ãƒ³
  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".single-delete-btn");
    if (btn) {
      e.preventDefault(); // â€»ãƒªãƒ³ã‚¯ï¼ˆæ‹¡å¤§è¡¨ç¤ºï¼‰ã®ç™ºç«ã‚’é˜²ã
      deleteIllustrations([btn.dataset.id]);
    }
  });

  // ä¸€æ‹¬å‰Šé™¤ãƒœã‚¿ãƒ³
  if (bulkDeleteBtn) {
    bulkDeleteBtn.addEventListener("click", () => {
      const selectedIds = Array.from(document.querySelectorAll(".delete-checkbox:checked"))
                               .map(cb => cb.dataset.id);
      deleteIllustrations(selectedIds);
    });
  }
});
</script>